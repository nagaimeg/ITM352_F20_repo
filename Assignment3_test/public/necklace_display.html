<!--Author: Meghan Nagai-->
<!--followed getting started with Assignment1 html copied SmartPhoneProducts 3 and w3 template-->
<!--code adjusted from Assignment 1 to fit Assignment 3-->
<!--help from Johnathan Kan-->

<script src="./products_data.js" type="text/javascript"></script>
<script> var product = "necklaces"; </script>
<script>
  //function taken from w3 schools from workshops
  function getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie); //decode the cookie
    var ca = decodedCookie.split(';'); //split up string by ';'
    for (var i = 0; i < ca.length; i++) { //split up by names
      var c = ca[i];
      while (c.charAt(0) == ' ') {
        c = c.substring(1);
      }
      if (c.indexOf(name) == 0) {
        return c.substring(name.length, c.length);
      }
    }
    return "";
  };
  //copied from Lab 13 and used in Assignment 1/2
  function isNonNegInt(q, return_errors = false) { //function that identifies invalid numbers
    errors = []; // assume no errors at first
    if (q == "") q = 0; // handle blank inputs as if they are 0
    if (Number(q) != q) errors.push('<font color="red">Not an amount</font>'); // Check if string is a number value
    if (q < 0) errors.push('<font color="red">Negative amount</font>'); // Check if it is non-negative
    if (parseInt(q) != q) errors.push('<font color="red">Not a full amount</font>'); // Check that it is an integer
    return return_errors ? errors : (errors.length == 0); // returns if there are errors or not
  }

  //copied from Lab 13 and used in Assignment 1/2
  function checkQuantityTextbox(theTextbox) { //Function to state the error message if there is invalid input
    errs = isNonNegInt(theTextbox.value, true); //setting variable 'errs' to isNonNegtInt being false for the value entered in quantity_textbox
    document.getElementById(theTextbox.name + '_message').innerHTML = errs.join(", "); // gets quantity_textbox_message and sets it to the error message from the isNonNegtInt function, joined by a comma if there is more than one error
  }

  //referenced from Johnathan Kan code
  function saveProduct(i) { //Function to save amount to cart
    var amountProduct = product_form[`quantity${i}`].value;
    if (isNonNegInt(amountProduct) == true) { //if there are no errors...
      sessionStorage[`${product}${i}`] = amountProduct; //save this amount to this user's session
      document.getElementById(`cart${i}`).innerHTML = 'Added to Cart!'; //let user know product was added
    } else {
      document.getElementById(`cart${i}`).innerHTML = 'Cannot Add to Cart: Please Enter Valid Amount'; //let user know to input actual amount
    };
    window.location.reload();
  };

  //referenced from Johnathan Kan  and Lexy Dennis code
  window.onload = function () { //this page and all of the related files are loaded before this function is
    let params = (new URL(document.location)).searchParams; // get the query string which has the form data

    if (params.has('purchase_submit_button')) { // after the form is submitted this checks that quantities are valid before redirecting to the invoice
      errors = false; // assume quantities are valid from the start
      total_qty = 0; // need to check if something was selected so we will look if the total > 0

      for (i = 0; i < allProducts[product].length; i++) { //for every product in the array...

        if (params.has(`quantity${i}`)) { // check the quantity for input
          qty = params.get(`quantity${i}`); //get the value for quantity_textbox for any given product and make textbox sticky in case of invalid data
          quantity_form[`quantity${i}`].value = qty; // the value of quantity_textbox is set to variable 'qty'
          total_qty += qty; // adds the most recently-loaded quantity_textbox value to the total value

          if (!isNonNegInt(qty)) { // if qty is not a valid input
            errors = true; // there are errors
            checkQuantityTextbox(product_form[`quantity${i}`]); // use checkQuantityTextbox to return the error message for the quantity_textbox (located in the quantity_form) that has an invalid input entered in it
          }

        }

      }

      if (errors) { // Now respond to errors or redirect to invoice if all is ok
        alert("Please enter valid amount");
      } else if (total_qty == 0) { // no quantity selections, just give a general alert
        alert("Please select a product before submitting your purchase order");
      }

    }

  }
</script>

<!DOCTYPE html>
<html>
<title>Meghan's Diamond Necklace Store</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!--link to style sheet template from the w3schools templates-->
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Karma">
<!--Setting the font for the document-->
<style>
  body,
  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-family: "Karma", sans-serif
  }

  .w3-bar-block .w3-bar-item {
    padding: 20px
  }

  /*format the navigation bar*/
  nav {
    padding-top: 100px;
    text-align: center;
  }
</style>
<!--setting the background image to be the starry.jpg-->

<body style="background-image: url(images/starry.jpg);  background-repeat: no-repeat; background-size:cover;">

  <!--navigation bar-->
  <nav>
    <a href="./index.html"><img src="images/home.png" height="200px" width="200px"></a>        
    <a href="./bracelet_display.html"><img src="images/bracelets.png" height="200px" width="200px"></a>
    <a href="./earring_display.html"><img src="images/earrings.png" height="200px" width="200px"></a>
    <a href="./ring_display.html"><img src="images/rings.png" height="200px" width="200px"></a>
    <script>
      var username = getCookie('username');
      if(username != "") {
          document.write(`<a href="./logout"><img src="images/logout.png" height="200px" width="200px"></a>;`);
      } else{
          document.write(`<a href="./login"><img src="images/login.png" height="200px" width="200px"></a>`);
      }
  </script>
    <a href="./cart.html"><img src="images/cart.png" height="200px" width="200px"></a>
  </nav>

  <!-- Formatting the Top menu from w3 schools template -->
  <div class="w3-top">
    <div class="w3-white w3-xlarge" style="max-width:1200px;margin:auto; ">
      <div class="w3-center w3-padding-16" style="background-color: palevioletred">Diamond Bracelets for the Perfect
        Gem!</div>
    </div>
  </div>

  <!--what to do with the form-->
  <form name="product_form" action="/process_form" method="POST">

    <!-- !PAGE CONTENT! from w3 schools template -->
    <div class="w3-main w3-content w3-padding" style="max-width:1200px;margin-top:100px;">
      <script>
        for (i = 0; i < allProducts[product].length; i++) {
          document.write(`    
    <!-- First Photo Grid and formatt the image size-->
    <!--Display the products, brand, product name, and price-->
    <div class="w3-row-padding w3-padding-16 w3-center" style="background-color:pink">
        <img src="${allProducts[product][i]['image']}"style="width:300px; height: 300px;>
      <div style="width=300px">
      <h2>${allProducts[product][i]['brand']}</h2>
        <p>${allProducts[product][i]['product_name']}</p>
        <p>$${allProducts[product][i]['price']}</p>

      <label>Quantity:</label>
            <input id="textbox${i}" type="text" name="quantity${i}" onkeyup="checkQuantityTextbox(this) placeholder="Enter a quantity";">
            <span id="quantity_textbox${i}_message"></span>


            <!--format the purchase button-->
            <br><br>
    <input type="submit" value="Add to Cart"
      style="height:40px; width:150px; margin:auto 0; text-align: center; background-color: palevioletred; font-size: 18px;  font-weight: 700;"
      name="addProducts${i}" onclick="saveProduct(${i})">

      <span id="cart${i}"></span>
            `)

            if (typeof sessionStorage[`${product}${i}`] != 'undefined') {
                                product_form[`quantity${i}`].value = sessionStorage[`${product}${i}`];
                            }
        }
      </script>
    </div>

  </form>
  </div>
  <h1>
    <footer>

      <h1 class="w3-center" style="background-color: palevioletred;">Account Information</h1>
      <div style="text-align: center;">
      <script>
          var theUser = getCookie('name'); 
          var theUsername = getCookie('username'); 
          var email = getCookie('email'); 
          var lastVisited = getCookie('last_login_time'); 
          if (theUsername != '') { 
              document.write(`
                  <p>Logged in as:${theUsername}</font><p> 
              `)
          } else {
              document.write(`
                  <p>Not logged in. Please<a href="./login">login</a></p>
              `)
          };
          var cart = sessionStorage.length;
          if (cart > 0) {
              document.write(`
                  <p>Shopping Cart has <font color="#629DD1">${cart}</font> products</p>
              `)
          } else {
              document.write(`
                  <p>Shopping cart is empty</p>
              `)
          };
      </script>


    </footer>
  </h1>
</body>

</html>